<%- include('../partials/header') %>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">
                    <%= user ? 'Edit User' : 'Create New User' %>
                </h2>
                <a href="/users" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-times"></i>
                </a>
            </div>

            <div class="p-6">
                <% if (locals.error) { %>
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
                        <p>
                            <%= error %>
                        </p>
                    </div>
                    <% } %>

                        <form action="<%= user ? '/users/' + user.id : '/users' %>" method="POST">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="name">
                                    Full Name
                                </label>
                                <input
                                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                    id="name" type="text" name="name" value="<%= user ? user.name : '' %>" required
                                    placeholder="John Doe">
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
                                    Email Address
                                </label>
                                <input
                                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                    id="email" type="email" name="email" value="<%= user ? user.email : '' %>" required
                                    placeholder="john@example.com">
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="roleId">
                                    Role
                                </label>
                                <div class="relative">
                                    <select
                                        class="block appearance-none w-full bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline"
                                        id="roleId" name="roleId" required>
                                        <option value="">Select a Role</option>
                                        <% roles.forEach(function(role) { %>
                                            <option value="<%= role.id %>" <%=(user && user.roleId===role.id)
                                                ? 'selected' : '' %>>
                                                <%= role.name %>
                                            </option>
                                            <% }); %>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20">
                                            <path
                                                d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="managerId">
                                    Reporting Manager (Optional)
                                </label>
                                <div class="relative">
                                    <select
                                        class="block appearance-none w-full bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline"
                                        id="managerId" name="managerId">
                                        <option value="">None</option>
                                        <% if (typeof managers !=='undefined' ) { %>
                                            <% managers.forEach(function(manager) { %>
                                                <!-- Prevent user from selecting themselves -->
                                                <% if (!user || user.id !==manager.id) { %>
                                                    <option value="<%= manager.id %>" <%=(user &&
                                                        user.managerId===manager.id) ? 'selected' : '' %>>
                                                        <%= manager.name %> (<%= manager.Role ? manager.Role.name
                                                                : 'Unknown' %>)
                                                    </option>
                                                    <% } %>
                                                        <% }); %>
                                                            <% } %>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20">
                                            <path
                                                d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-6">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="password">
                                    Password <%= user ? '(Leave blank to keep current)' : '' %>
                                </label>
                                <input
                                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
                                    id="password" type="password" name="password" placeholder="******************"
                                    <%=user ? '' : 'required' %>>
                            </div>

                            <div class="flex items-center justify-end">
                                <a href="/users"
                                    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2 transition duration-150">
                                    Cancel
                                </a>
                                <button
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150"
                                    type="submit">
                                    <%= user ? 'Update User' : 'Create User' %>
                                </button>
                            </div>
                        </form>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>