<%- include('../partials/header') %>

    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Supervisor Command</h1>
            <p class="text-gray-600">Overview of your assigned site operations.</p>
        </div>
        <div class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold">
            <i class="fas fa-user-shield mr-2"></i> Role: Supervisor
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow p-6 border-l-4 border-blue-500">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-gray-500 text-sm font-bold uppercase">My Sites</p>
                    <p class="text-3xl font-bold text-gray-800">
                        <%= stats.mySites %>
                    </p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                    <i class="fas fa-building fa-lg"></i>
                </div>
            </div>
            <% if(sites.length> 0) { %>
                <p class="text-xs text-gray-400 mt-2">
                    <%= sites[0].name %>
                </p>
                <% } %>
        </div>

        <div class="bg-white rounded-xl shadow p-6 border-l-4 border-green-500">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-gray-500 text-sm font-bold uppercase">Active Shifts</p>
                    <p class="text-3xl font-bold text-gray-800">
                        <%= stats.activeShifts %>
                    </p>
                </div>
                <div class="bg-green-100 p-3 rounded-full text-green-600">
                    <i class="fas fa-clock fa-lg"></i>
                </div>
            </div>
            <a href="/dashboard/live" class="text-xs text-green-600 hover:underline mt-2 inline-block">Monitor Live Map
                &rarr;</a>
        </div>

        <div class="bg-white rounded-xl shadow p-6 border-l-4 border-red-500">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-gray-500 text-sm font-bold uppercase">Open Incidents</p>
                    <p class="text-3xl font-bold text-gray-800">
                        <%= stats.pendingIncidents %>
                    </p>
                </div>
                <div class="bg-red-100 p-3 rounded-full text-red-600">
                    <i class="fas fa-exclamation-triangle fa-lg"></i>
                </div>
            </div>
            <a href="/incidents" class="text-xs text-red-600 hover:underline mt-2 inline-block">View Reports &rarr;</a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content: Sites List -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden mb-8">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-bold text-gray-700">My Assigned Site</h2>
                </div>
                <div class="p-6">
                    <% if (sites.length> 0) { %>
                        <div class="space-y-4">
                            <% sites.forEach(site=> { %>
                                <div
                                    class="border rounded-lg p-4 flex flex-col md:flex-row justify-between items-center hover:bg-gray-50 transition">
                                    <div class="mb-4 md:mb-0">
                                        <h3 class="font-bold text-lg text-gray-800">
                                            <%= site.name %>
                                        </h3>
                                        <p class="text-sm text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>
                                            <%= site.address || 'No address' %>
                                        </p>
                                    </div>
                                    <div class="flex space-x-3">
                                        <a href="/sites/<%= site.id %>"
                                            class="px-4 py-2 bg-indigo-600 text-white text-sm font-bold rounded hover:bg-indigo-700 transition">
                                            Manage Site
                                        </a>
                                        <a href="/sites/<%= site.id %>?tab=schedule"
                                            class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-bold rounded hover:bg-gray-300 transition">
                                            Schedule
                                        </a>
                                    </div>
                                </div>
                                <% }) %>
                        </div>
                        <% } else { %>
                            <div class="text-center py-10">
                                <div
                                    class="bg-gray-100 rounded-full h-16 w-16 flex items-center justify-center mx-auto mb-4 text-gray-400">
                                    <i class="fas fa-building fa-2x"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900">No sites assigned</h3>
                                <p class="text-gray-500 mt-1">Contact your administrator to be assigned to a site.</p>
                            </div>
                            <% } %>
                </div>
            </div>

            <!-- Guard Status Section -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden mb-8">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-gray-700">Personnel Status</h2>
                    <span class="text-xs font-bold text-gray-400 uppercase">Live Updates</span>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4" id="guard-status-list">
                        <% if (locals.guards && guards.length > 0) { %>
                            <% guards.forEach(guard => { %>
                                <div class="flex items-center p-3 border rounded-lg hover:shadow-sm transition" id="guard-row-<%= guard.id %>">
                                    <div class="relative">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">
                                            <%= guard.name.charAt(0) %>
                                        </div>
                                        <div class="status-dot absolute bottom-0 right-0 w-3 h-3 bg-gray-400 border-2 border-white rounded-full" id="status-dot-<%= guard.id %>"></div>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-bold text-gray-800"><%= guard.name %></p>
                                        <p class="text-[10px] text-gray-500 uppercase font-medium"><%= guard.Role ? guard.Role.name : 'Guard' %></p>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="col-span-full text-center py-4 text-gray-400 italic">No guards assigned to your sites.</div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar: Recent Incidents -->
        <div>
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-bold text-gray-700">Recent Incidents</h2>
                </div>
                <div class="divide-y divide-gray-100">
                    <% if (recentIncidents.length> 0) { %>
                        <% recentIncidents.forEach(inc=> { %>
                            <div class="p-4 hover:bg-gray-50 transition block">
                                <div class="flex justify-between items-start mb-1">
                                    <span
                                        class="text-xs font-bold px-2 py-0.5 rounded-full <%= inc.priority === 'high' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800' %> uppercase">
                                        <%= inc.type %>
                                    </span>
                                    <span class="text-xs text-gray-400">
                                        <%= new Date(inc.createdAt).toLocaleDateString() %>
                                    </span>
                                </div>
                                <p class="text-sm text-gray-800 font-medium mb-1">
                                    <%= inc.description %>
                                </p>
                                <p class="text-xs text-gray-500">@ <%= inc.Site ? inc.Site.name : 'Unknown Site' %>
                                </p>
                                <a href="/incidents/<%= inc.id %>"
                                    class="text-xs text-blue-600 hover:underline mt-2 block">View Details &rarr;</a>
                            </div>
                            <% }) %>
                                <% } else { %>
                                    <div class="p-6 text-center text-gray-400 text-sm italic">No recent incidents.</div>
                                    <% } %>
                </div>
                <div class="bg-gray-50 p-3 text-center">
                    <a href="/incidents" class="text-sm font-bold text-blue-600 hover:text-blue-800">View All
                        Incidents</a>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();

            socket.on('user_connected', (data) => {
                const dot = document.getElementById(`status-dot-${data.userId}`);
                if (dot) {
                    dot.classList.remove('bg-gray-400');
                    dot.classList.add('bg-green-500');
                }
            });

            socket.on('user_disconnected', (userId) => {
                const dot = document.getElementById(`status-dot-${userId}`);
                if (dot) {
                    dot.classList.remove('bg-green-500');
                    dot.classList.add('bg-gray-400');
                }
            });

            socket.on('active_users_list', (users) => {
                users.forEach(user => {
                    const dot = document.getElementById(`status-dot-${user.userId}`);
                    if (dot) {
                        dot.classList.remove('bg-gray-400');
                        dot.classList.add('bg-green-500');
                    }
                });
            });

            socket.emit('request_active_users');
        });
    </script>

    <%- include('../partials/footer') %>