<%- include('../partials/header') %>

    <div class="max-w-4xl mx-auto">
        <!-- Header / Title -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <a href="/incidents" class="text-gray-500 hover:text-gray-700"><i class="fas fa-arrow-left"></i>
                        Back</a>
                    <h1 class="text-3xl font-bold text-gray-800">Incident #<%= incident.id %>
                    </h1>
                </div>
                <p class="text-gray-500 mt-1 ml-0 md:ml-16">Reported on <%= new
                        Date(incident.createdAt).toLocaleString() %>
                </p>
            </div>
            <div class="flex gap-2">
                <% let pColor='gray' ; if(incident.priority==='high' ) pColor='orange' ;
                    if(incident.priority==='critical' ) pColor='red' ; if(incident.priority==='medium' ) pColor='yellow'
                    ; if(incident.priority==='low' ) pColor='green' ; %>
                    <span
                        class="px-3 py-1 rounded-full font-bold uppercase bg-<%= pColor %>-100 text-<%= pColor %>-800">
                        <%= incident.priority %>
                    </span>

                    <% let sColor='blue' ; if(incident.status==='new' ) sColor='purple' ;
                        if(incident.status==='resolved' ) sColor='green' ; if(incident.status==='investigating' )
                        sColor='indigo' ; %>
                        <span
                            class="px-3 py-1 rounded-full font-bold uppercase bg-<%= sColor %>-100 text-<%= sColor %>-800">
                            <%= incident.status %>
                        </span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Main Content -->
            <div class="md:col-span-2 space-y-6">
                <!-- Description Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Description</h2>
                    <div class="mb-4">
                        <span class="block text-xs font-bold text-gray-400 uppercase tracking-wide">Type</span>
                        <span class="text-lg text-gray-900 font-semibold">
                            <%= incident.type %>
                        </span>
                    </div>
                    <div>
                        <span class="block text-xs font-bold text-gray-400 uppercase tracking-wide">Details</span>
                        <p class="text-gray-700 whitespace-pre-line mt-1">
                            <%= incident.description || 'No description provided.' ?>
                        </p>
                    </div>
                </div>

                <!-- Resolution Info (if resolved) -->
                <% if (incident.status==='resolved' ) { %>
                    <div class="bg-green-50 rounded-lg shadow p-6 border border-green-200">
                        <h2 class="text-xl font-bold text-green-800 mb-4 border-b border-green-200 pb-2">Resolution</h2>
                        <div class="mb-4">
                            <span class="block text-xs font-bold text-green-600 uppercase tracking-wide">Resolution
                                Notes</span>
                            <p class="text-gray-800 whitespace-pre-line mt-1">
                                <%= incident.resolutionNotes || 'No notes provided.' ?>
                            </p>
                        </div>
                        <% if(incident.evidencePath) { %>
                            <div>
                                <span
                                    class="block text-xs font-bold text-green-600 uppercase tracking-wide mb-2">Evidence</span>
                                <img src="<%= incident.evidencePath %>"
                                    class="w-full rounded-lg border border-green-200 shadow-sm"
                                    alt="Resolution Evidence">
                            </div>
                            <% } %>
                    </div>
                    <% } else { %>
                <!-- Evidence (Initial Report) if exists -->
                <% if((incident.evidence && incident.evidence.length > 0) || incident.evidencePath) { %>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Attached Evidence</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="incident-gallery">
                            <% if(incident.evidencePath) { %>
                                <div class="cursor-pointer group relative overflow-hidden rounded-lg border border-gray-100" 
                                     onclick="openLightbox('<%= incident.evidencePath %>')">
                                    <img src="<%= incident.evidencePath %>" class="w-full h-32 object-cover transition group-hover:scale-105" alt="Evidence">
                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition flex items-center justify-center">
                                        <i class="fas fa-search-plus text-white opacity-0 group-hover:opacity-100 transition"></i>
                                    </div>
                                </div>
                            <% } %>
                            <% if(incident.evidence) { %>
                                <% incident.evidence.forEach(ev => { %>
                                    <div class="cursor-pointer group relative overflow-hidden rounded-lg border border-gray-100" 
                                         onclick="openLightbox('<%= ev.filePath %>')">
                                        <img src="<%= ev.filePath %>" class="w-full h-32 object-cover transition group-hover:scale-105" alt="Evidence">
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition flex items-center justify-center">
                                            <i class="fas fa-search-plus text-white opacity-0 group-hover:opacity-100 transition"></i>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>
                    </div>
                <% } %>
            </div>

            <!-- Sidebar Details -->
            <!-- ... sidebar ... -->
        </div>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="fixed inset-0 bg-black bg-opacity-90 z-[10000] hidden flex items-center justify-center p-4" onclick="closeLightbox()">
        <button class="absolute top-6 right-6 text-white text-3xl hover:text-gray-300 transition" onclick="closeLightbox()">
            <i class="fas fa-times"></i>
        </button>
        <img id="lightbox-img" src="" class="max-w-full max-h-full rounded shadow-2xl animate__animated animate__zoomIn" onclick="event.stopPropagation()">
    </div>

    <script>
        function openLightbox(src) {
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = src;
            lb.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            const lb = document.getElementById('lightbox');
            lb.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Escape to close
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });

        function openResolveModal(id) {
            document.getElementById('resolveForm').action = `/incidents/${id}/resolve`;
            document.getElementById('resolveModal').classList.remove('hidden');
        }

        function openAssignModal(id, type) {
            document.getElementById('assignForm').action = `/incidents/${id}/assign`;
            document.getElementById('modalIncidentType').textContent = type || 'Incident';
            document.getElementById('assignModal').classList.remove('hidden');
        }
    </script>

    <%- include('../partials/footer') %>